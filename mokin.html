<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æœ¨ç´ã‚¢ãƒ—ãƒª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* å…¨ä½“ã®èƒŒæ™¯ï¼ˆåºŠãªã©ï¼‰ */
        body {
            background-color: #e5e5e5;
        }

        /* æœ¨ç´ã®é»’ã„ãƒ•ãƒ¬ãƒ¼ãƒ ï¼ˆå°åº§ï¼‰ */
        .xylophone-frame {
            background-color: #1a1a1a;
            border-radius: 16px;
            box-shadow: 
                0 20px 50px rgba(0,0,0,0.5),
                inset 0 0 0 2px #333;
            position: relative;
            /* ã‚¿ãƒƒãƒæ“ä½œã®æœ€é©åŒ– */
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
            overflow: hidden;
        }

        /* ç·‘è‰²ã®ãƒ•ã‚§ãƒ«ãƒˆï¼ˆç·©è¡æï¼‰ã®ãƒ©ã‚¤ãƒ³ */
        .felt-line {
            position: absolute;
            height: 12px;
            width: 95%;
            background-color: #2e7d32;
            border-radius: 6px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);
            z-index: 0;
            left: 2.5%;
            pointer-events: none;
        }

        /* éµç›¤å…±é€šã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆãƒ­ãƒ¼ã‚ºã‚¦ãƒƒãƒ‰èª¿ï¼‰ */
        .key {
            cursor: pointer;
            transition: transform 0.05s, filter 0.05s;
            position: relative;
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            -webkit-tap-highlight-color: transparent;
            pointer-events: auto;
            z-index: 10;
            
            /* ãƒªã‚¢ãƒ«ãªæœ¨ç›®ï¼ˆèµ¤èŒ¶è‰²ï¼‰ */
            background-color: #8D4E36;
            background-image: 
                /* æœ¨ç›®ã‚¹ã‚¸ */
                repeating-linear-gradient(90deg, transparent 0, transparent 2px, rgba(0,0,0,0.1) 3px, transparent 4px),
                /* ç«‹ä½“æ„Ÿã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã¨ã‚·ãƒ£ãƒ‰ã‚¦ */
                linear-gradient(to right, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0) 10%, rgba(0,0,0,0.1) 90%, rgba(0,0,0,0.3) 100%),
                /* ä¸¸ã¿ã®è¡¨ç¾ï¼ˆä¸Šä¸‹ï¼‰ */
                linear-gradient(to bottom, rgba(255,255,255,0.1) 0%, transparent 20%, transparent 80%, rgba(0,0,0,0.2) 100%);
            
            box-shadow: 
                2px 4px 8px rgba(0,0,0,0.4), /* è½ã¡å½± */
                inset 1px 1px 1px rgba(255,255,255,0.3); /* ã‚¨ãƒƒã‚¸ã®å…‰ */
        }

        /* ç™½éµ */
        .key-natural {
            width: 85%;
            height: 100%;
        }

        /* é»’éµ */
        .key-accidental {
            position: absolute;
            top: -45%;
            right: -25%; /* ç™½éµã®é–“ã«é…ç½® */
            width: 50%;
            height: 60%;
            z-index: 20;
            
            /* é»’éµã‚‚åŒã˜æœ¨æã ãŒã€å°‘ã—ã ã‘åŒºåˆ¥ã‚’ã¤ã‘ã‚‹ãŸã‚ã«æš—ãã™ã‚‹ */
            filter: brightness(0.95); 
            box-shadow: 
                3px 6px 10px rgba(0,0,0,0.5),
                inset 1px 1px 1px rgba(255,255,255,0.2);
        }

        /* ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ™‚ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .key:active, .key.active {
            transform: scale(0.97) translateY(2px);
            filter: brightness(1.1); /* æŠ¼ã—ãŸã¨ãã«å°‘ã—æ˜ã‚‹ã */
        }
        
        .key-accidental:active, .key-accidental.active {
            transform: scale(0.97) translateY(2px);
            filter: brightness(1.05);
        }

        /* ç™½ã„ç•™ã‚å…·ï¼ˆãƒ”ãƒ³ï¼‰ */
        .pin {
            width: 10px;
            height: 10px;
            background: radial-gradient(circleAt 30% 30%, #fff, #ddd);
            border-radius: 50%;
            box-shadow: 0 1px 2px rgba(0,0,0,0.5);
            margin: 8px 0;
            pointer-events: none;
            z-index: 15;
        }

        /* ç„¼å°é¢¨ã®æ–‡å­— */
        .key-label {
            color: #3e2723; /* æ¿ƒã„ç„¦ã’èŒ¶ */
            text-shadow: 0 1px 0 rgba(255,255,255,0.2), 0 -1px 0 rgba(0,0,0,0.3); /* å½«ã‚Šè¾¼ã¿åŠ¹æœ */
            opacity: 0.8;
            pointer-events: none;
            font-family: "Hiragino Mincho ProN", "Yu Mincho", serif; /* æ˜æœä½“ã§å’Œé¢¨ã« */
        }

        .key-sub {
            pointer-events: none;
            color: #3e2723;
            opacity: 0.5;
        }

        /* æ¨ªç”»é¢æ™‚ã®èª¿æ•´ */
        @media (orientation: landscape) and (max-height: 500px) {
            .xylophone-frame {
                height: 85vh;
            }
        }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden flex flex-col items-center justify-center font-sans bg-stone-200">

    <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« -->
    <div class="absolute top-4 left-0 w-full flex justify-center z-50 pointer-events-none">
        <div class="bg-white/90 backdrop-blur-sm px-4 py-2 rounded-full shadow-lg flex items-center gap-4 pointer-events-auto border border-stone-200">
            <h1 class="text-stone-700 font-bold tracking-wider text-sm sm:text-base">ğŸ¶ æœ¨ç´</h1>
            <div class="h-4 w-px bg-stone-300"></div>
            <select id="instrument-select" class="bg-transparent border-none outline-none text-stone-700 font-bold cursor-pointer text-sm">
                <option value="sine">æœ¨ç´ (Standard)</option>
                <option value="triangle">é‰„ç´ (Soft)</option>
                <option value="square">8bit (Retro)</option>
                <option value="sawtooth">ã‚·ãƒ³ã‚» (Sharp)</option>
            </select>
        </div>
    </div>

    <!-- æ¡ˆå†…ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆiOSãªã©ã§éŸ³ãŒå‡ºãªã„å ´åˆç”¨ï¼‰ -->
    <div id="start-overlay" class="absolute inset-0 z-[60] flex items-center justify-center bg-black/50 transition-opacity duration-300 pointer-events-none opacity-0">
        <div class="bg-white px-6 py-4 rounded-xl shadow-2xl text-center">
            <p class="font-bold text-stone-700">ç”»é¢ã‚’ã‚¿ãƒƒãƒ—ã—ã¦é–‹å§‹</p>
            <p class="text-xs text-stone-500 mt-1">â€»ãƒãƒŠãƒ¼ãƒ¢ãƒ¼ãƒ‰ã‚’è§£é™¤ã—ã¦ãã ã•ã„</p>
        </div>
    </div>

    <!-- æœ¨ç´æœ¬ä½“ã‚¨ãƒªã‚¢ -->
    <div class="xylophone-frame w-[95%] max-w-5xl h-[60vh] sm:h-[60vh] max-h-[600px] flex flex-col justify-center items-center p-4 sm:p-8 relative">
        
        <!-- èƒŒæ™¯ã®ãƒ•ã‚§ãƒ«ãƒˆãƒ©ã‚¤ãƒ³ï¼ˆä¸Šæ®µãƒ»é»’éµç”¨ï¼‰ -->
        <div class="felt-line" style="top: 20%;"></div>
        <div class="felt-line" style="top: 45%;"></div>

        <!-- èƒŒæ™¯ã®ãƒ•ã‚§ãƒ«ãƒˆãƒ©ã‚¤ãƒ³ï¼ˆä¸‹æ®µãƒ»ç™½éµç”¨ï¼‰ -->
        <div class="felt-line" style="bottom: 15%;"></div>
        <div class="felt-line" style="bottom: 45%;"></div>

        <!-- éµç›¤ã‚¨ãƒªã‚¢ -->
        <div id="xylophone-board" class="flex justify-center items-end w-full h-full gap-1 sm:gap-2 relative z-10 pt-[15%]">
            <!-- JSã§ç”Ÿæˆ -->
        </div>
        
        <p class="text-white/30 text-[10px] mt-2 font-mono absolute bottom-2 tracking-widest uppercase">Rosewood Xylophone</p>
    </div>

    <script>
        // éŸ³éšãƒ‡ãƒ¼ã‚¿å®šç¾©ï¼ˆã²ã‚‰ãŒãªè¡¨è¨˜ã«å¤‰æ›´ï¼‰
        const keysData = [
            { note: 'C4', freq: 261.63, label: 'ã©', height: 100, sharp: { note: 'C#4', freq: 277.18 } },
            { note: 'D4', freq: 293.66, label: 'ã‚Œ', height: 96, sharp: { note: 'D#4', freq: 311.13 } },
            { note: 'E4', freq: 329.63, label: 'ã¿', height: 92, sharp: null }, 
            { note: 'F4', freq: 349.23, label: 'ãµã', height: 88, sharp: { note: 'F#4', freq: 369.99 } },
            { note: 'G4', freq: 392.00, label: 'ã', height: 84, sharp: { note: 'G#4', freq: 415.30 } },
            { note: 'A4', freq: 440.00, label: 'ã‚‰', height: 80, sharp: { note: 'A#4', freq: 466.16 } },
            { note: 'B4', freq: 493.88, label: 'ã—', height: 76, sharp: null }, 
            { note: 'C5', freq: 523.25, label: 'ã©', height: 72, sharp: null }
        ];

        let audioCtx;
        const instrumentSelect = document.getElementById('instrument-select');
        const board = document.getElementById('xylophone-board');
        const startOverlay = document.getElementById('start-overlay');

        // AudioContextåˆæœŸåŒ–ï¼ˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆã®ã¿ï¼‰
        function createAudioContext() {
            if (!audioCtx) {
                // webkitAudioContextã¯iOS/Safariç”¨
                const AudioContextClass = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContextClass();
            }
        }

        // éŸ³ã‚’é³´ã‚‰ã™ãƒ¡ã‚¤ãƒ³é–¢æ•°
        function playTone(freq, typeOverride) {
            // ã¾ã ä½œæˆã•ã‚Œã¦ãªã‘ã‚Œã°ä½œæˆ
            createAudioContext();
            
            // é‡è¦ï¼šã‚µã‚¹ãƒšãƒ³ãƒ‰çŠ¶æ…‹ãªã‚‰å†é–‹ã‚’è©¦ã¿ã‚‹
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }

            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            const type = typeOverride || instrumentSelect.value;
            
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);

            const now = audioCtx.currentTime;
            
            // ã‚¨ãƒ³ãƒ™ãƒ­ãƒ¼ãƒ—ï¼ˆéŸ³ã®æ¸›è¡°è¨­å®šï¼‰
            if (type === 'sine') {
                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(1, now + 0.005);
                gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.4);
            } else if (type === 'triangle') {
                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(0.6, now + 0.005);
                gainNode.gain.exponentialRampToValueAtTime(0.01, now + 1.2);
            } else {
                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(0.4, now + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
            }

            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            osc.start();
            osc.stop(now + 2);
            
            setTimeout(() => {
                osc.disconnect();
                gainNode.disconnect();
            }, 2000);
        }

        // éµç›¤ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯
        keysData.forEach((data) => {
            const wrapper = document.createElement('div');
            wrapper.className = 'relative flex-1 flex justify-center items-end h-full'; 

            const naturalKey = document.createElement('div');
            naturalKey.className = 'key key-natural';
            naturalKey.style.height = `${data.height}%`;
            naturalKey.dataset.freq = data.freq;
            
            naturalKey.innerHTML = `
                <div class="pin"></div>
                <div class="flex flex-col items-center justify-center mt-auto mb-auto">
                    <span class="key-label text-2xl sm:text-3xl font-bold mb-1">${data.label}</span>
                    <span class="key-sub text-[10px] font-mono">${data.note}</span>
                </div>
                <div class="pin"></div>
            `;
            wrapper.appendChild(naturalKey);

            if (data.sharp) {
                const sharpKey = document.createElement('div');
                sharpKey.className = 'key key-accidental';
                sharpKey.dataset.freq = data.sharp.freq;
                sharpKey.innerHTML = `
                    <div class="pin scale-75 mt-2"></div>
                    <div class="pin scale-75 mt-auto mb-2"></div>
                `;
                wrapper.appendChild(sharpKey);
            }
            board.appendChild(wrapper);
        });

        // ---------------------------------------------------------
        // iOS/iPadOSå‘ã‘ã®å¼·åŠ›ãªã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚¢ãƒ³ãƒ­ãƒƒã‚¯å‡¦ç†
        // ---------------------------------------------------------
        let isAudioUnlocked = false;

        function unlockAudio(e) {
            if (isAudioUnlocked) return;

            createAudioContext();

            // 1. Contextã‚’å†é–‹
            if (audioCtx.state === 'suspended') {
                audioCtx.resume().then(() => {
                    console.log('AudioContext resumed successfully');
                }).catch(err => {
                    console.error('Failed to resume AudioContext:', err);
                });
            }

            // 2. iOSå¯¾ç­–ï¼šç„¡éŸ³ã®ãƒãƒƒãƒ•ã‚¡ã‚’ä¸€ç¬å†ç”Ÿã—ã¦ã‚¨ãƒ³ã‚¸ãƒ³ã‚’å¼·åˆ¶çš„ã«èµ·ã“ã™
            // ã“ã‚Œã‚’è¡Œã‚ãªã„ã¨ã€resume()ã ã‘ã§ã¯éŸ³ãŒé³´ã‚‰ãªã„å ´åˆãŒã‚ã‚‹
            const buffer = audioCtx.createBuffer(1, 1, 22050);
            const source = audioCtx.createBufferSource();
            source.buffer = buffer;
            source.connect(audioCtx.destination);
            source.start(0);

            isAudioUnlocked = true;
            
            // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’éè¡¨ç¤ºã«
            if (startOverlay) {
                startOverlay.style.opacity = '0';
                setTimeout(() => startOverlay.style.display = 'none', 300);
            }

            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼å‰Šé™¤
            ['click', 'touchstart', 'touchend', 'keydown'].forEach(evt => 
                document.body.removeEventListener(evt, unlockAudio)
            );
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæœ€åˆã«ä½•ã‹ã—ã‚‰æ“ä½œã—ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã‚¢ãƒ³ãƒ­ãƒƒã‚¯ã‚’å®Ÿè¡Œ
        ['click', 'touchstart', 'touchend', 'keydown'].forEach(evt => 
            document.body.addEventListener(evt, unlockAudio, { once: true, capture: true })
        );
        
        // åˆå›ãƒ­ãƒ¼ãƒ‰æ™‚ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æ“ä½œã‚’ä¿ƒã™è¡¨ç¤ºï¼ˆä¸€ç¬ã ã‘å‡ºã—ã¦ã€è‡ªç„¶ã«æ¶ˆã™ï¼‰
        if(audioCtx && audioCtx.state === 'suspended') {
             startOverlay.style.opacity = '1';
             startOverlay.style.pointerEvents = 'auto';
        }


        // ---------------------------------------------------------
        // ã‚¿ãƒƒãƒ & ã‚°ãƒªãƒƒã‚µãƒ³ãƒ‰å‡¦ç†
        // ---------------------------------------------------------

        function triggerKey(keyElement) {
            if (!keyElement) return;
            
            // ã¾ã ãƒ­ãƒƒã‚¯è§£é™¤ã•ã‚Œã¦ãªã„å ´åˆã«å‚™ãˆã¦ã“ã“ã§ã‚‚å‘¼ã¶
            if (!isAudioUnlocked) unlockAudio();

            const freq = parseFloat(keyElement.dataset.freq);
            if (!freq) return;

            playTone(freq);

            keyElement.classList.remove('active');
            void keyElement.offsetWidth;
            keyElement.classList.add('active');
            setTimeout(() => keyElement.classList.remove('active'), 120);
        }

        const activeTouches = new Map();
        const touchArea = document.querySelector('.xylophone-frame');

        const handleTouch = (e) => {
            if (e.cancelable && e.type !== 'touchend') e.preventDefault();

            const touches = e.touches;
            const currentTouchIds = new Set();

            for (let i = 0; i < touches.length; i++) {
                const touch = touches[i];
                currentTouchIds.add(touch.identifier);

                const element = document.elementFromPoint(touch.clientX, touch.clientY);
                const key = element ? element.closest('.key') : null;

                const previousKey = activeTouches.get(touch.identifier);

                if (key && key !== previousKey) {
                    triggerKey(key);
                    activeTouches.set(touch.identifier, key);
                } else if (!key) {
                    activeTouches.set(touch.identifier, null);
                }
            }

            for (const [id] of activeTouches) {
                if (!currentTouchIds.has(id)) {
                    activeTouches.delete(id);
                }
            }
        };

        let isMouseDown = false;
        let lastHoveredKey = null;

        const handleMouse = (e) => {
            if (e.type === 'mousedown') {
                isMouseDown = true;
                const key = e.target.closest('.key');
                if (key) {
                    triggerKey(key);
                    lastHoveredKey = key;
                }
            } else if (e.type === 'mouseup' || e.type === 'mouseleave') {
                isMouseDown = false;
                lastHoveredKey = null;
            } else if (e.type === 'mousemove' && isMouseDown) {
                const key = e.target.closest('.key');
                if (key && key !== lastHoveredKey) {
                    triggerKey(key);
                    lastHoveredKey = key;
                }
            }
        };

        touchArea.addEventListener('touchstart', handleTouch, { passive: false });
        touchArea.addEventListener('touchmove', handleTouch, { passive: false });
        touchArea.addEventListener('touchend', handleTouch);
        touchArea.addEventListener('touchcancel', handleTouch);

        touchArea.addEventListener('mousedown', handleMouse);
        touchArea.addEventListener('mousemove', handleMouse);
        window.addEventListener('mouseup', handleMouse);

    </script>
</body>
</html>