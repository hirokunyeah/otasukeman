<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Singing Bowl - Digital Resonance</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel (for JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Custom Styles -->
    <style>
        body {
            background-color: #171717; /* neutral-900 */
            color: #e5e5e5; /* neutral-200 */
            overflow: hidden;
            touch-action: none; /* Prevent mobile scrolling */
        }
        @keyframes spin-slow {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin-slow {
            animation: spin-slow 60s linear infinite;
        }
        @keyframes fade-in-up {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-up {
            animation: fade-in-up 0.5s ease-out forwards;
        }
        @keyframes fade-in {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .animate-fade-in {
            animation: fade-in 0.3s ease-out forwards;
        }
        /* Custom range slider styling */
        input[type=range] {
            -webkit-appearance: none;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
        }
        input[type=range]:focus {
            outline: none;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // --- Icons (Simple SVG Components to replace Lucide) ---
        const IconBase = ({ size = 24, className = "", children }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );

        const Volume2 = (props) => <IconBase {...props}><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5" /><path d="M15.54 8.46a5 5 0 0 1 0 7.07" /><path d="M19.07 4.93a10 10 0 0 1 0 14.14" /></IconBase>;
        const Activity = (props) => <IconBase {...props}><polyline points="22 12 18 12 15 21 9 3 6 12 2 12" /></IconBase>;
        const RotateCcw = (props) => <IconBase {...props}><path d="M3 2v6h6" /><path d="M3 13a9 9 0 1 0 3-7.7L3 8" /></IconBase>;
        const Waves = (props) => <IconBase {...props}><path d="M2 6c.6.5 1.2 1 2.5 1C7 7 7 5 9.5 5c2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1" /><path d="M2 12c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1" /><path d="M2 18c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1" /></IconBase>;
        const Square = (props) => <IconBase {...props}><rect x="3" y="3" width="18" height="18" rx="2" ry="2" /></IconBase>;
        const Zap = (props) => <IconBase {...props}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" /></IconBase>;
        const Settings = (props) => <IconBase {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" /><circle cx="12" cy="12" r="3" /></IconBase>;
        const Headphones = (props) => <IconBase {...props}><path d="M3 18v-6a9 9 0 0 1 18 0v6" /><path d="M21 19a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h3zM3 19a2 2 0 0 0 2 2h1a2 2 0 0 0 2-2v-3a2 2 0 0 0-2-2H3z" /></IconBase>;
        const Save = (props) => <IconBase {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" /><polyline points="17 21 17 13 7 13 7 21" /><polyline points="7 3 7 8 15 8" /></IconBase>;
        const Trash2 = (props) => <IconBase {...props}><polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /><line x1="10" y1="11" x2="10" y2="17" /><line x1="14" y1="11" x2="14" y2="17" /></IconBase>;
        const ChevronDown = (props) => <IconBase {...props}><polyline points="6 9 12 15 18 9" /></IconBase>;
        const Plus = (props) => <IconBase {...props}><line x1="12" y1="5" x2="12" y2="19" /><line x1="5" y1="12" x2="19" y2="12" /></IconBase>;


        // --- 音響定数 ---
        const HARMONICS = [
            { ratio: 1.000, baseGain: 0.40, decay: 15.0 }, // 基音
            { ratio: 2.778, baseGain: 0.25, decay: 10.0 }, // 第1倍音
            { ratio: 5.180, baseGain: 0.15, decay: 7.0 },  // 第2倍音
            { ratio: 8.210, baseGain: 0.08, decay: 5.0 },  // 第3倍音
        ];

        // デフォルトプリセット
        const DEFAULT_PRESETS = [
            { id: 'earth', name: 'Earth (Om) 136Hz', freq: 136.1, beat: 1.5, stereo: 1.0, gain: 0.2 },
            { id: 'sleep', name: 'Deep Sleep (Delta)', freq: 110.0, beat: 1.0, stereo: 0.8, gain: 0.3 },
            { id: 'focus', name: 'Focus (Alpha) 256Hz', freq: 256.0, beat: 8.0, stereo: 0.5, gain: 1.0 },
            { id: 'solar', name: 'Solar Plexus 528Hz', freq: 528.0, beat: 2.5, stereo: 0.9, gain: 0.6 },
            { id: 'root',  name: 'Root Chakra 194Hz', freq: 194.2, beat: 4.0, stereo: 0.6, gain: 0.8 },
        ];

        const App = () => {
            // --- State ---
            const [isPlaying, setIsPlaying] = useState(false);
            const [volume, setVolume] = useState(0.8);
            
            // Audio Params
            const [gainBoost, setGainBoost] = useState(0.2);   
            const [baseFreq, setBaseFreq] = useState(136.1);     
            const [beatSpeed, setBeatSpeed] = useState(1.5);   
            const [stereoWidth, setStereoWidth] = useState(1.0); 

            // Preset Management
            const [presets, setPresets] = useState(DEFAULT_PRESETS);
            const [selectedPresetId, setSelectedPresetId] = useState('earth');
            const [isPresetMenuOpen, setIsPresetMenuOpen] = useState(false);
            const [newPresetName, setNewPresetName] = useState('');
            const [isSaving, setIsSaving] = useState(false);

            const [energy, setEnergy] = useState(0); 
            const [mode, setMode] = useState('tap'); 
            const [showGuide, setShowGuide] = useState(true);
            
            // --- Refs ---
            const audioCtxRef = useRef(null);
            const masterGainRef = useRef(null);
            const oscillatorsRef = useRef([]);
            const animationFrameRef = useRef(null);
            const lastMousePos = useRef({ x: 0, y: 0 });
            const lastTime = useRef(0);
            
            const modeRef = useRef(mode);
            const gainBoostRef = useRef(gainBoost);

            useEffect(() => { modeRef.current = mode; }, [mode]);
            useEffect(() => { gainBoostRef.current = gainBoost; }, [gainBoost]);

            // --- Load User Presets on Mount ---
            useEffect(() => {
                try {
                    const saved = localStorage.getItem('singingBowlUserPresets');
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        setPresets([...DEFAULT_PRESETS, ...parsed]);
                    }
                } catch (e) {
                    console.error("Failed to load presets", e);
                }
            }, []);

            // --- Preset Logic ---
            const applyPreset = (preset) => {
                setBaseFreq(preset.freq);
                setBeatSpeed(preset.beat);
                setStereoWidth(preset.stereo);
                setGainBoost(preset.gain);
                setSelectedPresetId(preset.id);
                setIsPresetMenuOpen(false);
            };

            const handleSavePreset = () => {
                if (!newPresetName.trim()) return;
                
                const newPreset = {
                id: `user-${Date.now()}`,
                name: newPresetName,
                freq: baseFreq,
                beat: beatSpeed,
                stereo: stereoWidth,
                gain: gainBoost
                };

                const updatedPresets = [...presets, newPreset];
                setPresets(updatedPresets);
                setSelectedPresetId(newPreset.id);
                
                // Save only user presets to localStorage
                const userPresets = updatedPresets.filter(p => p.id.startsWith('user-'));
                localStorage.setItem('singingBowlUserPresets', JSON.stringify(userPresets));

                setNewPresetName('');
                setIsSaving(false);
            };

            const handleDeletePreset = (id, e) => {
                e.stopPropagation();
                const updatedPresets = presets.filter(p => p.id !== id);
                setPresets(updatedPresets);
                if (selectedPresetId === id) {
                    setSelectedPresetId('custom'); // Reset selection if deleted
                }
                
                const userPresets = updatedPresets.filter(p => p.id.startsWith('user-'));
                localStorage.setItem('singingBowlUserPresets', JSON.stringify(userPresets));
            };

            // Check if current settings match selected preset
            useEffect(() => {
                const current = presets.find(p => p.id === selectedPresetId);
                if (current) {
                    if (
                        Math.abs(current.freq - baseFreq) > 0.1 ||
                        Math.abs(current.beat - beatSpeed) > 0.1 ||
                        Math.abs(current.stereo - stereoWidth) > 0.01 ||
                        Math.abs(current.gain - gainBoost) > 0.01
                    ) {
                        setSelectedPresetId('custom');
                    }
                }
            }, [baseFreq, beatSpeed, stereoWidth, gainBoost, presets, selectedPresetId]);


            // --- Audio Engine Initialization ---
            const initAudio = useCallback(() => {
                if (audioCtxRef.current) return;

                const AudioContext = window.AudioContext || window.webkitAudioContext;
                const ctx = new AudioContext();
                audioCtxRef.current = ctx;

                const masterGain = ctx.createGain();
                masterGain.gain.value = volume;
                masterGain.connect(ctx.destination);
                masterGainRef.current = masterGain;

                HARMONICS.forEach((h) => {
                    const osc1 = ctx.createOscillator();
                    const osc2 = ctx.createOscillator();
                    const gainNode = ctx.createGain();
                    
                    const pannerL = ctx.createStereoPanner ? ctx.createStereoPanner() : null;
                    const pannerR = ctx.createStereoPanner ? ctx.createStereoPanner() : null;

                    osc1.type = 'sine';
                    osc2.type = 'sine';

                    // Apply current settings on init
                    const freq = baseFreq * h.ratio;
                    osc1.frequency.value = freq;
                    const detuneFreq = freq + beatSpeed + (baseFreq * 0.002);
                    osc2.frequency.value = detuneFreq;

                    gainNode.gain.value = 0;
                    
                    if (pannerL && pannerR) {
                        osc1.connect(pannerL);
                        pannerL.connect(gainNode);
                        osc2.connect(pannerR);
                        pannerR.connect(gainNode);
                        pannerL.pan.value = -stereoWidth; 
                        pannerR.pan.value = stereoWidth; 
                    } else {
                        osc1.connect(gainNode);
                        osc2.connect(gainNode);
                    }

                    gainNode.connect(masterGain);
                    osc1.start();
                    osc2.start();
                    
                    oscillatorsRef.current.push({ 
                        osc1, osc2, gainNode, 
                        pannerL, pannerR, 
                        ratio: h.ratio, 
                        baseGain: h.baseGain,
                        decay: h.decay
                    });
                });

                setIsPlaying(true);
                startPhysicsLoop();
            }, [baseFreq, beatSpeed, stereoWidth, volume]); 

            // --- Parameter Updates ---
            useEffect(() => {
                if (!audioCtxRef.current) return;
                oscillatorsRef.current.forEach(node => {
                    if (node.pannerL && node.pannerR) {
                        node.pannerL.pan.setTargetAtTime(-stereoWidth, audioCtxRef.current.currentTime, 0.1);
                        node.pannerR.pan.setTargetAtTime(stereoWidth, audioCtxRef.current.currentTime, 0.1);
                    }
                });
            }, [stereoWidth]);

            useEffect(() => {
                if (!audioCtxRef.current) return;
                oscillatorsRef.current.forEach(node => {
                    const freq = baseFreq * node.ratio;
                    node.osc1.frequency.setTargetAtTime(freq, audioCtxRef.current.currentTime, 0.1);
                    const detuneFreq = freq + beatSpeed + (baseFreq * 0.002);
                    node.osc2.frequency.setTargetAtTime(detuneFreq, audioCtxRef.current.currentTime, 0.1);
                });
            }, [baseFreq, beatSpeed]);

            useEffect(() => {
                if (masterGainRef.current && audioCtxRef.current) {
                    masterGainRef.current.gain.setTargetAtTime(volume, audioCtxRef.current.currentTime, 0.1);
                }
            }, [volume]);

            // --- Physics Loop ---
            const startPhysicsLoop = () => {
                const loop = () => {
                    setEnergy(prev => {
                        let next = prev * 0.98;
                        if (next < 0.001) next = 0;
                        return next;
                    });

                    if (audioCtxRef.current) {
                        const now = audioCtxRef.current.currentTime;
                        const currentMode = modeRef.current;
                        const currentBoost = gainBoostRef.current;
                        
                        if (currentMode === 'rub') {
                            oscillatorsRef.current.forEach((node, idx) => {
                                const threshold = idx * 0.2; 
                                let targetGain = 0;
                                if (energy > threshold) {
                                    const normalizedEnergy = (energy - threshold) / (1 - threshold);
                                    targetGain = normalizedEnergy * node.baseGain * currentBoost;
                                }
                                node.gainNode.gain.setTargetAtTime(targetGain, now, 0.1);
                            });
                        }
                    }
                    animationFrameRef.current = requestAnimationFrame(loop);
                };
                loop();
            };

            useEffect(() => {
                return () => {
                    if (animationFrameRef.current) cancelAnimationFrame(animationFrameRef.current);
                    if (audioCtxRef.current) audioCtxRef.current.close();
                };
            }, []);

            // --- Interaction Handlers ---
            const handleTap = () => {
                if (!audioCtxRef.current) initAudio();
                if (audioCtxRef.current?.state === 'suspended') audioCtxRef.current.resume();
                setMode('tap');
                const now = audioCtxRef.current.currentTime;
                setEnergy(1.0); 
                oscillatorsRef.current.forEach(node => {
                    const peakGain = node.baseGain * gainBoostRef.current;
                    node.gainNode.gain.cancelScheduledValues(now);
                    node.gainNode.gain.setValueAtTime(0, now);
                    node.gainNode.gain.linearRampToValueAtTime(peakGain, now + 0.02);
                    node.gainNode.gain.exponentialRampToValueAtTime(0.001, now + node.decay);
                });
            };

            const handleRubMove = (clientX, clientY, rect) => {
                if (!audioCtxRef.current) initAudio();
                if (audioCtxRef.current?.state === 'suspended') audioCtxRef.current.resume();
                if (mode !== 'rub') setMode('rub');

                const nowTime = Date.now();
                const dt = nowTime - lastTime.current;
                
                if (dt > 0) {
                    const dx = clientX - lastMousePos.current.x;
                    const dy = clientY - lastMousePos.current.y;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    const speed = dist / dt;

                    const centerX = rect.width / 2;
                    const centerY = rect.height / 2;
                    const x = clientX - rect.left;
                    const y = clientY - rect.top;
                    const distFromCenter = Math.sqrt(Math.pow(x - centerX, 2) + Math.pow(y - centerY, 2));
                    const maxRadius = rect.width / 2;
                    const isOnRim = distFromCenter > (maxRadius * 0.4) && distFromCenter < (maxRadius * 0.95);

                    if (isOnRim) {
                        const gain = Math.min(speed * 0.3, 0.05); 
                        setEnergy(prev => Math.min(prev + gain, 1.0));
                    }
                }
                lastMousePos.current = { x: clientX, y: clientY };
                lastTime.current = nowTime;
            };

            const handleStop = () => {
                if (!audioCtxRef.current) return;
                const now = audioCtxRef.current.currentTime;
                setEnergy(0);
                oscillatorsRef.current.forEach(node => {
                    node.gainNode.gain.cancelScheduledValues(now);
                    node.gainNode.gain.setTargetAtTime(0, now, 0.05);
                });
            };

            // --- UI Components ---
            return (
                <div className="min-h-screen flex flex-col items-center justify-center p-4 relative">
                
                {/* Background Ambience */}
                <div className="absolute inset-0 overflow-hidden pointer-events-none">
                    <div 
                        className={`absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[800px] h-[800px] bg-amber-500/5 rounded-full blur-3xl transition-all ease-in-out`}
                        style={{ 
                            animation: `pulse ${1/beatSpeed}s infinite alternate`,
                            transform: `translate(-50%, -50%) scale(${energy > 0.1 ? 1.2 : 1})`,
                            opacity: energy > 0.1 ? 1 : 0.3
                        }}
                    ></div>
                </div>

                {/* Header */}
                <div className="absolute top-6 left-0 right-0 text-center z-10">
                    <h1 className="text-2xl font-light tracking-widest text-amber-100/80 mb-1">SINGING BOWL</h1>
                    <p className="text-xs text-neutral-500 tracking-wider uppercase">Digital Resonance Synthesis</p>
                </div>

                {/* Main Bowl Interaction Area */}
                <div className="relative w-full max-w-md aspect-square flex items-center justify-center mb-4">
                    <div className="absolute inset-0 rounded-full border border-neutral-700/30 transition-transform duration-[4000ms] ease-in-out" style={{ transform: `scale(${1 + Math.sin(Date.now() / 2000) * 0.05})` }}></div>
                    <div className="absolute w-[85%] h-[85%] rounded-full border-2 border-dashed border-amber-500/10 pointer-events-none animate-spin-slow" style={{ animationDuration: '60s' }}></div>
                    <div 
                    className="relative w-[70%] h-[70%] rounded-full cursor-pointer touch-none group transition-all duration-100"
                    style={{ 
                        background: 'radial-gradient(circle at 30% 30%, #cd7f32, #4a3b2a)',
                        boxShadow: `0 0 ${20 + energy * 100}px rgba(205, 127, 50, ${0.2 + energy * 0.6})`,
                        transform: `scale(${1 + energy * 0.02})`
                    }}
                    onClick={handleTap}
                    onMouseMove={(e) => { if (e.buttons === 1) handleRubMove(e.clientX, e.clientY, e.currentTarget.getBoundingClientRect()); }}
                    onTouchMove={(e) => { e.preventDefault(); const touch = e.touches[0]; handleRubMove(touch.clientX, touch.clientY, e.currentTarget.getBoundingClientRect()); }}
                    onMouseDown={(e) => { lastMousePos.current = { x: e.clientX, y: e.clientY }; lastTime.current = Date.now(); }}
                    onTouchStart={(e) => { const touch = e.touches[0]; lastMousePos.current = { x: touch.clientX, y: touch.clientY }; lastTime.current = Date.now(); handleTap(); }}
                    >
                        <div className="absolute top-[10%] left-[10%] w-[30%] h-[20%] bg-white/10 rounded-full blur-xl filter"></div>
                        <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                            <span className={`text-amber-100/50 font-light tracking-widest transition-opacity duration-500 ${energy > 0.1 ? 'opacity-100' : 'opacity-0'}`}>OM</span>
                        </div>
                    </div>
                    {showGuide && (
                        <div className="absolute pointer-events-none text-center bg-black/60 backdrop-blur-sm p-4 rounded-xl text-sm text-neutral-300 animate-fade-in-up">
                            <p className="mb-2"><span className="text-amber-400 font-bold">Tap</span> center to Strike</p>
                            <p><span className="text-amber-400 font-bold">Rub</span> the edge to Sing</p>
                            <button onClick={(e) => {e.stopPropagation(); setShowGuide(false);}} className="mt-3 text-xs border border-white/20 px-3 py-1 rounded-full hover:bg-white/10 pointer-events-auto">Got it</button>
                        </div>
                    )}
                </div>

                {/* Controls */}
                <div className="w-full max-w-sm bg-neutral-800/50 backdrop-blur-md rounded-2xl p-6 border border-neutral-700/50 shadow-2xl z-20 space-y-5">
                    
                    {/* Presets Selection */}
                    <div className="relative z-30">
                        <div className="flex justify-between items-center mb-2">
                            <div className="flex items-center gap-2 text-purple-400/80">
                                <Settings size={14} />
                                <span className="text-[10px] font-bold tracking-wider uppercase">Preset</span>
                            </div>
                            {selectedPresetId === 'custom' && <span className="text-[10px] text-neutral-400 italic">Custom Settings</span>}
                        </div>
                        
                        <div className="flex gap-2">
                            <button 
                                onClick={() => setIsPresetMenuOpen(!isPresetMenuOpen)}
                                className="flex-1 flex items-center justify-between bg-neutral-700/50 hover:bg-neutral-700 px-3 py-2 rounded-lg text-xs transition-colors text-left"
                            >
                                <span className="truncate">{presets.find(p => p.id === selectedPresetId)?.name || 'Custom'}</span>
                                <ChevronDown size={14} className={`transition-transform ${isPresetMenuOpen ? 'rotate-180' : ''}`} />
                            </button>
                            <button 
                                onClick={() => setIsSaving(!isSaving)}
                                className={`p-2 rounded-lg transition-colors ${isSaving ? 'bg-amber-500 text-black' : 'bg-neutral-700/50 hover:bg-neutral-700 text-neutral-300'}`}
                                title="Save Current Settings"
                            >
                                <Save size={16} />
                            </button>
                        </div>

                        {/* Save Preset Input */}
                        {isSaving && (
                            <div className="mt-2 flex gap-2 animate-fade-in">
                                <input 
                                    type="text" 
                                    value={newPresetName}
                                    onChange={(e) => setNewPresetName(e.target.value)}
                                    placeholder="Preset Name..."
                                    className="flex-1 bg-neutral-900 border border-neutral-600 rounded-lg px-2 py-1 text-xs focus:outline-none focus:border-amber-500"
                                    autoFocus
                                    onKeyDown={(e) => e.key === 'Enter' && handleSavePreset()}
                                />
                                <button onClick={handleSavePreset} className="bg-amber-500 hover:bg-amber-400 text-black p-1 rounded-lg">
                                    <Plus size={16} />
                                </button>
                            </div>
                        )}

                        {/* Dropdown Menu */}
                        {isPresetMenuOpen && (
                            <div className="absolute top-full left-0 right-0 mt-1 bg-neutral-800 border border-neutral-700 rounded-lg shadow-xl max-h-60 overflow-y-auto z-40">
                                {presets.map(p => (
                                    <div 
                                        key={p.id}
                                        onClick={() => applyPreset(p)}
                                        className={`flex justify-between items-center px-3 py-2 text-xs hover:bg-neutral-700 cursor-pointer ${selectedPresetId === p.id ? 'bg-neutral-700/50 text-amber-400' : 'text-neutral-300'}`}
                                    >
                                        <div className="flex flex-col">
                                            <span className="font-medium">{p.name}</span>
                                            <span className="text-[9px] text-neutral-500">{Math.round(p.freq)}Hz • {p.beat}Hz beat</span>
                                        </div>
                                        {p.id.startsWith('user-') && (
                                            <button 
                                                onClick={(e) => handleDeletePreset(p.id, e)}
                                                className="p-1 hover:text-red-400 text-neutral-500 transition-colors"
                                            >
                                                <Trash2 size={12} />
                                            </button>
                                        )}
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>

                    {/* Freq & Stereo */}
                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <div className="flex justify-between items-center mb-1">
                                <div className="flex items-center gap-1 text-amber-500/80">
                                    <Activity size={14} />
                                    <span className="text-[10px] font-bold tracking-wider uppercase">Freq</span>
                                </div>
                                <span className="text-[10px] font-mono text-neutral-400">{Math.round(baseFreq)}Hz</span>
                            </div>
                            <input type="range" min="50" max="600" value={baseFreq} onChange={(e) => setBaseFreq(Number(e.target.value))} className="w-full h-1 bg-neutral-700 rounded-lg appearance-none cursor-pointer [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-3 [&::-webkit-slider-thumb]:h-3 [&::-webkit-slider-thumb]:bg-amber-500 [&::-webkit-slider-thumb]:rounded-full hover:[&::-webkit-slider-thumb]:scale-110 transition-all" />
                        </div>
                        <div>
                            <div className="flex justify-between items-center mb-1">
                                <div className="flex items-center gap-1 text-teal-400/80">
                                    <Headphones size={14} />
                                    <span className="text-[10px] font-bold tracking-wider uppercase">Stereo</span>
                                </div>
                                <span className="text-[10px] font-mono text-neutral-400">{Math.round(stereoWidth * 100)}%</span>
                            </div>
                            <input type="range" min="0" max="1" step="0.01" value={stereoWidth} onChange={(e) => setStereoWidth(Number(e.target.value))} className="w-full h-1 bg-neutral-700 rounded-lg appearance-none cursor-pointer [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-3 [&::-webkit-slider-thumb]:h-3 [&::-webkit-slider-thumb]:bg-teal-400 [&::-webkit-slider-thumb]:rounded-full hover:[&::-webkit-slider-thumb]:scale-110 transition-all" />
                        </div>
                    </div>

                    {/* Pulsation */}
                    <div>
                        <div className="flex justify-between items-center mb-1">
                            <div className="flex items-center gap-2 text-blue-400/80">
                                <Waves size={16} />
                                <span className="text-xs font-bold tracking-wider uppercase">Pulsation Speed</span>
                            </div>
                            <span className="text-xs font-mono text-neutral-400">{beatSpeed.toFixed(1)} Hz</span>
                        </div>
                        <input type="range" min="0.1" max="10.0" step="0.1" value={beatSpeed} onChange={(e) => setBeatSpeed(Number(e.target.value))} className="w-full h-1 bg-neutral-700 rounded-lg appearance-none cursor-pointer [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-4 [&::-webkit-slider-thumb]:h-4 [&::-webkit-slider-thumb]:bg-blue-400 [&::-webkit-slider-thumb]:rounded-full hover:[&::-webkit-slider-thumb]:scale-110 transition-all" />
                    </div>

                    {/* Gain Boost */}
                    <div>
                        <div className="flex justify-between items-center mb-1">
                            <div className="flex items-center gap-2 text-rose-400/80">
                                <Zap size={16} />
                                <span className="text-xs font-bold tracking-wider uppercase">Resonance Gain</span>
                            </div>
                            <span className="text-xs font-mono text-neutral-400">x{gainBoost.toFixed(1)}</span>
                        </div>
                        <input type="range" min="0.0" max="3.0" step="0.1" value={gainBoost} onChange={(e) => setGainBoost(Number(e.target.value))} className="w-full h-1 bg-neutral-700 rounded-lg appearance-none cursor-pointer [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-4 [&::-webkit-slider-thumb]:h-4 [&::-webkit-slider-thumb]:bg-rose-400 [&::-webkit-slider-thumb]:rounded-full hover:[&::-webkit-slider-thumb]:scale-110 transition-all" />
                    </div>

                    {/* Volume & Footer Controls */}
                    <div className="flex items-center gap-4 pt-2 border-t border-neutral-700/50">
                        <div className="flex-1">
                            <div className="flex items-center gap-2 mb-2 text-neutral-400">
                                <Volume2 size={16} />
                                <span className="text-xs uppercase tracking-wider">Volume</span>
                            </div>
                            <input type="range" min="0" max="1" step="0.01" value={volume} onChange={(e) => setVolume(Number(e.target.value))} className="w-full h-1 bg-neutral-700 rounded-lg appearance-none cursor-pointer [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-4 [&::-webkit-slider-thumb]:h-4 [&::-webkit-slider-thumb]:bg-neutral-400 [&::-webkit-slider-thumb]:rounded-full" />
                        </div>
                        <div className="flex gap-2 mt-4">
                            <button onClick={handleStop} className="p-3 rounded-full bg-red-500/10 hover:bg-red-500/30 text-red-400 transition-colors" title="Stop">
                                <Square size={16} fill="currentColor" />
                            </button>
                            <button onClick={() => applyPreset(DEFAULT_PRESETS[0])} className="p-3 rounded-full bg-neutral-700/50 hover:bg-neutral-700 text-neutral-400 transition-colors" title="Reset to Default">
                                <RotateCcw size={16} />
                            </button>
                        </div>
                    </div>
                </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>